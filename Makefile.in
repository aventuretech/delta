include config.local

ASM := $(shell which nasm)
QMU := $(shell which qemu-system-x86_64)
GCC := $(shell which clang)
LNK := $(shell which ld)

CFL = -c -ffreestanding -Wall -Wextra \
-Iinclude -nostdlib -std=c99 -fno-stack-protector -mno-red-zone
OUT = out/main.o out/interrupt_asm.o out/system.o out/interrupt.o \
out/strings.o out/screen.o out/idt.o out/io.o

all: out out/bmfs_mbr.sys out/pure64.sys out/boot_asm.o $(OUT) out/kernel.sys out/delta.image

# Instead of running the provided "build.sh"
include contrib/pure64/build.make

out:
	mkdir -p out/

# So if we change any headers, main.c will get recompiled
out/main.o: src/main.c include/*.h
	$(GCC) $(CFL) -o$@ $<

out/%_asm.o:
	$(ASM) -felf64 -o$@ `find src -name $(*F).asm`

out/%.o:
	$(GCC) $(CFL) -o$@ `find src -name $(*F).c`

out/kernel.sys: $(OUT)
	$(LNK) -Tlink.ld $^ -o$@

out/delta.image: out/bmfs_mbr.sys out/pure64.sys out/kernel.sys
	bmfs $@ initialize 6M $^

clean:
	rm -rf out configure config.log config.local autom4te.cache Makefile config.status

qemu: all
	$(QMU) -smp 2 -hda out/delta.image -name "Delta"